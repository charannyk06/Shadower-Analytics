# Microservices Architecture Definition
# Shadower Analytics Platform

services:
  analytics-api:
    description: Main analytics API service
    port: 8000
    dependencies:
      - postgres
      - redis
      - message-queue
    responsibilities:
      - API gateway
      - Request routing
      - Authentication
      - Rate limiting
    scaling:
      min_instances: 2
      max_instances: 10
      cpu_threshold: 70
      memory_threshold: 80
    health_check:
      endpoint: /health
      interval: 30s
      timeout: 5s

  metrics-processor:
    description: Real-time metrics processing
    port: 8001
    dependencies:
      - kafka
      - redis
      - timeseries-db
    responsibilities:
      - Event streaming
      - Metrics aggregation
      - Real-time calculations
    scaling:
      min_instances: 2
      max_instances: 5
      cpu_threshold: 80
      memory_threshold: 85
    health_check:
      endpoint: /health
      interval: 30s
      timeout: 5s

  report-generator:
    description: Report generation service
    port: 8002
    dependencies:
      - postgres
      - s3
      - pdf-renderer
    responsibilities:
      - Report scheduling
      - Template rendering
      - Export generation
    scaling:
      min_instances: 1
      max_instances: 5
      cpu_threshold: 75
      memory_threshold: 80
    health_check:
      endpoint: /health
      interval: 60s
      timeout: 10s

  notification-service:
    description: Notification and alert service
    port: 8003
    dependencies:
      - redis
      - smtp
      - webhook-queue
    responsibilities:
      - Alert processing
      - Email sending
      - Webhook delivery
    scaling:
      min_instances: 1
      max_instances: 3
      cpu_threshold: 70
      memory_threshold: 75
    health_check:
      endpoint: /health
      interval: 30s
      timeout: 5s

  data-aggregator:
    description: Background data aggregation
    port: 8004
    dependencies:
      - postgres
      - redis
      - scheduler
    responsibilities:
      - Materialized view refresh
      - Data rollups
      - Archive management
    scaling:
      min_instances: 1
      max_instances: 3
      cpu_threshold: 80
      memory_threshold: 85
    health_check:
      endpoint: /health
      interval: 60s
      timeout: 10s

# Infrastructure Components
infrastructure:
  postgres:
    type: database
    version: "15"
    replicas: 1
    backup_schedule: "0 2 * * *"  # Daily at 2 AM
    retention_days: 30

  redis:
    type: cache
    version: "7"
    mode: cluster
    nodes: 3
    persistence: true

  kafka:
    type: message-queue
    version: "3.5"
    brokers: 3
    topics:
      - analytics-events
      - metrics-stream
      - alert-events
    retention: 7d

  timeseries-db:
    type: database
    implementation: timescaledb
    version: "2.11"
    compression: true
    retention: 90d

# Service Communication Patterns
communication:
  sync:
    protocol: http
    timeout: 30s
    retry_attempts: 3
    circuit_breaker:
      enabled: true
      failure_threshold: 5
      timeout: 60s

  async:
    protocol: kafka
    consumer_groups:
      analytics: 3
      alerts: 2
      notifications: 2

  grpc:
    enabled: true
    services:
      - analytics-service
      - metrics-service
    load_balancing: round_robin

# Monitoring & Observability
monitoring:
  metrics:
    provider: prometheus
    port: 9090
    scrape_interval: 15s

  logging:
    provider: elk
    level: info
    structured: true

  tracing:
    provider: jaeger
    sample_rate: 0.1

  alerting:
    provider: alertmanager
    notification_channels:
      - slack
      - email
      - pagerduty

# Security
security:
  authentication:
    method: jwt
    token_expiry: 24h
    refresh_enabled: true

  authorization:
    method: rbac
    roles:
      - admin
      - developer
      - viewer

  encryption:
    at_rest: true
    in_transit: true
    tls_version: "1.3"

  rate_limiting:
    enabled: true
    strategy: sliding_window
    default_limit: 1000/hour

# Deployment
deployment:
  environment:
    development:
      replicas: 1
      resources:
        cpu: "500m"
        memory: "512Mi"

    staging:
      replicas: 2
      resources:
        cpu: "1000m"
        memory: "1Gi"

    production:
      replicas: 3
      resources:
        cpu: "2000m"
        memory: "2Gi"

  strategy:
    type: rolling
    max_surge: 1
    max_unavailable: 0

  health_checks:
    liveness:
      initial_delay: 30s
      period: 10s
      timeout: 5s
      failure_threshold: 3

    readiness:
      initial_delay: 10s
      period: 5s
      timeout: 3s
      failure_threshold: 3

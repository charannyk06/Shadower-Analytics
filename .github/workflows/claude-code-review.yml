name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    # Optional: Only run on specific file changes
    # paths:
    #   - "src/**/*.ts"
    #   - "src/**/*.tsx"
    #   - "src/**/*.js"
    #   - "src/**/*.jsx"

jobs:
  claude-review:
    # Optional: Filter by PR author
    # if: |
    #   github.event.pull_request.user.login == 'external-contributor' ||
    #   github.event.pull_request.user.login == 'new-developer' ||
    #   github.event.pull_request.user.author_association == 'FIRST_TIME_CONTRIBUTOR'

    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write
      actions: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        continue-on-error: true
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          show_full_output: true
          # See https://github.com/anthropics/claude-code-action/blob/main/docs/usage.md
          # or https://docs.claude.com/en/docs/claude-code/cli-reference for available options
          claude_args: '--allowed-tools "Bash(gh issue view:*),Bash(gh search:*),Bash(gh issue list:*),Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr list:*)"'
          prompt: |
            You are an expert code reviewer performing a comprehensive security, quality, and correctness analysis of a pull request. Your goal is to identify issues that could cause bugs, security vulnerabilities, data loss, or production failures. Review the changed code line-by-line AND examine the broader codebase context to understand how changes integrate with existing systems.

            ## Review Process

            Follow this methodology step-by-step:

            1. **Understand Intent**: Read the PR title, description, and all changed files to understand what this change is trying to accomplish and why.

            2. **Analyze Changes**: For each modified file, examine:
               - What behavior is changing?
               - What are the data flows and dependencies?
               - How does this interact with the rest of the codebase?

            3. **Identify Issues**: Look for problems in these priority areas:
               - **Security**: SQL injection, XSS, authentication bypass, exposed secrets, insecure dependencies, missing input validation, authorization checks, RLS policies
               - **Correctness**: Logic errors, race conditions, edge cases, null/undefined handling, data validation, type mismatches
               - **Performance**: N+1 queries, memory leaks, inefficient algorithms, missing indexes, unnecessary API calls, async/await patterns
               - **Reliability**: Error handling, logging, retry logic, graceful degradation, timeout handling
               - **Maintainability**: Code duplication, unclear naming, missing documentation, tight coupling, complexity

            4. **Reason About Severity**: For each issue, think through:
               - What could go wrong in production?
               - How likely is this to cause problems?
               - What's the blast radius if this fails?
               - Can this be exploited maliciously?

            5. **Provide Solutions**: Give specific, actionable recommendations with code examples where helpful.

            ## Severity Definitions

            **BLOCKING** - Must be fixed before merge:
            - Security vulnerabilities or data exposure (SQL injection, XSS, auth bypass, exposed secrets)
            - Bugs that break existing functionality or cause crashes
            - Data loss or corruption risks
            - Unhandled exceptions in critical paths
            - Breaking changes to public APIs without migration path

            **IMPORTANT** - Should be addressed (may merge with remediation plan):
            - Performance problems that could affect users (N+1 queries, memory leaks)
            - Missing error handling in important flows
            - Hard-to-maintain code that will cause future problems
            - Inadequate test coverage for risky changes
            - Potential race conditions or concurrency issues

            **SUGGESTION** - Nice to have improvements:
            - Code style and consistency improvements
            - Minor optimizations
            - Better naming or structure
            - Additional documentation
            - Refactoring opportunities

            ## Project-Specific Guidelines

            This is a **FastAPI backend + Next.js frontend** project with:
            - **Multi-tenant architecture** - Ensure workspace isolation is maintained
            - **Supabase/PostgreSQL** - Watch for SQL injection, RLS policies, query optimization
            - **JWT authentication** - Verify auth checks are present and correct
            - **TypeScript/React** - Check for type safety, React best practices
            - **Python/FastAPI** - Validate Pydantic schemas, async/await patterns
            - **Layered architecture** - Routers â†’ Services â†’ Database

            **Critical Areas to Focus On:**
            - Authentication and authorization (workspace access checks)
            - Database queries (SQL injection, RLS, performance, migration numbering)
            - API endpoints (input validation, error handling)
            - Frontend security (XSS prevention, CSRF protection)
            - Multi-tenant data isolation
            - Test coverage (target 80% coverage)

            ## Output Format

            Provide your review in this structured format:

            ### ðŸ“Š Summary
            Brief 2-3 sentence overview of the PR and your assessment

            ### âœ… Strengths
            - Positive aspect 1
            - Positive aspect 2

            ### ðŸ”´ Blocking Issues (Must Fix)

            For each blocking issue:
            - **`file:line`** - Brief title
              - **Reasoning**: Explain what the problem is, why it matters, and what could go wrong
              - **Recommendation**: Provide specific fix with code example if applicable

            ### ðŸŸ¡ Important Issues (Should Fix)

            For each important issue:
            - **`file:line`** - Brief title
              - **Reasoning**: Explain the concern and potential impact
              - **Recommendation**: Suggested improvement

            ### ðŸ’¡ Suggestions (Nice to Have)

            For each suggestion:
            - **`file:line`** - Brief title
              - **Reasoning**: Why this would be an improvement
              - **Recommendation**: How to implement

            ### ðŸ§ª Testing Recommendations
            Specific tests that should be added or scenarios to validate

            ### âœ¨ Final Recommendation
            - âœ… **APPROVE** - Ready to merge
            - âš ï¸ **APPROVE WITH SUGGESTIONS** - Can merge but should address suggestions
            - ðŸ”„ **REQUEST CHANGES** - Issues must be addressed
            - âŒ **BLOCK** - Critical issues prevent merge

            ## Examples of Quality Findings

            **Example 1 - BLOCKING Issue:**
            - **`backend/app/routers/auth.py:45`** - SQL Injection vulnerability in login endpoint
              - **Reasoning**: User input from `request.args.get('username')` is directly interpolated into SQL query without sanitization. Attacker could use payload `admin'--` to bypass authentication or `'; DROP TABLE users--` to delete data.
              - **Recommendation**: Use parameterized queries: `cursor.execute("SELECT * FROM users WHERE username = ?", (username,))`

            **Example 2 - IMPORTANT Issue:**
            - **`backend/app/services/payment_service.py:143`** - No error logging in payment processing
              - **Reasoning**: The catch block silently swallows exceptions during payment processing. If Stripe API fails, we have no visibility into why or how often. This will make production debugging extremely difficult.
              - **Recommendation**: Add structured logging with error details and stack trace.

            **Example 3 - SUGGESTION:**
            - **`frontend/lib/utils/formatter.ts:28`** - Array iteration can be more idiomatic
              - **Reasoning**: Using forEach with array.push() is less idiomatic than map(). The current approach works correctly but map() better expresses the transformation intent.
              - **Recommendation**: Replace: `items.forEach(item => result.push(transform(item)));` With: `const result = items.map(item => transform(item));`

            ## Edge Case Handling

            - **Large PR (>20 files)**: Focus on the most critical files first (auth, data access, API endpoints). Note if full review was limited by size.
            - **No issues found**: Explicitly state "No significant issues found" and highlight what was reviewed.
            - **Uncertainty**: If you're unsure about something, state your confidence level and reasoning: "I'm uncertain if this could cause X because Y. Recommend testing Z scenario."
            - **Missing context**: If you need more information to assess something properly, explicitly ask for it.

            ---

            **PR Context:**
            - **PR:** #${{ github.event.pull_request.number }}
            - **Repository:** ${{ github.repository }}
            - **Title:** ${{ github.event.pull_request.title }}
            - **Description:** ${{ github.event.pull_request.body }}

            Begin your review now. Think step-by-step, explain your reasoning, and provide actionable recommendations. Be thorough but practical - focus on issues that matter for production reliability and security.

            **CRITICAL**: You MUST post your complete review as a comment on this pull request. Use the GitHub CLI (`gh pr comment`) to post your review. The review MUST be posted - do not skip this step. Format your review exactly as specified above with all sections: Summary, Strengths, Blocking Issues (if any), Important Issues (if any), Suggestions (if any), Testing Recommendations, and Final Recommendation.

      - name: Verify Review Comment Posted
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.payload.pull_request.number;
            const workflowRunId = context.runId;
            const workflowStartTime = new Date(context.payload.pull_request.updated_at || new Date().toISOString());
            
            console.log('Checking if Claude posted review comment...');
            
            // Wait longer for Claude to post (up to 10 seconds)
            await new Promise(resolve => setTimeout(resolve, 10000));
            
            // Get all comments on the PR
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });
            
            // Check for review comments - look for ANY comment with review content
            // Don't restrict to bots only, as Claude might post as different user type
            const reviewComments = comments.data.filter(c => {
              const commentTime = new Date(c.created_at);
              const isRecent = commentTime >= workflowStartTime;
              
              // Check for review content markers
              const hasReviewContent = 
                c.body.includes('ðŸ“Š Summary') ||
                c.body.includes('Summary') ||
                c.body.includes('Blocking Issues') ||
                c.body.includes('Important Issues') ||
                c.body.includes('Suggestions') ||
                c.body.includes('Final Recommendation') ||
                c.body.includes('APPROVE') ||
                c.body.includes('REQUEST CHANGES') ||
                (c.body.includes('ðŸ¤–') && c.body.includes('Claude'));
              
              return isRecent && hasReviewContent;
            });
            
            if (reviewComments.length > 0) {
              console.log(`âœ… Found ${reviewComments.length} review comment(s) posted by Claude`);
              reviewComments.forEach((comment, idx) => {
                console.log(`Comment ${idx + 1} by ${comment.user.login} at ${comment.created_at}`);
                console.log(`Preview: ${comment.body.substring(0, 150)}...`);
              });
            } else {
              console.log('âš ï¸ No review comment found in PR comments.');
              console.log('This could mean:');
              console.log('1. Claude is still processing (check workflow logs)');
              console.log('2. Claude encountered an error');
              console.log('3. Claude posted but comment detection failed');
              console.log('');
              console.log(`Check workflow logs: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${workflowRunId}`);
              console.log('');
              console.log('Total comments found:', comments.data.length);
              console.log('Recent comments:', comments.data.filter(c => new Date(c.created_at) >= workflowStartTime).length);
            }

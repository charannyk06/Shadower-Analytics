name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, ready_for_review]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to review'
        required: true
        type: string

jobs:
  claude-review:
    # Optional: Filter by PR author
    # if: |
    #   github.event.pull_request.user.login == 'external-contributor' ||
    #   github.event.pull_request.user.login == 'new-developer' ||
    #   github.event.pull_request.author_association == 'FIRST_TIME_CONTRIBUTOR'

    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Fetch full history for proper PR context
          fetch-depth: 0
          # Checkout the PR head ref for pull_request events
          ref: ${{ github.event.pull_request.head.sha || github.sha }}

      - name: Set PR number
        id: pr-info
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "pr_number=${{ github.event.inputs.pr_number }}" >> $GITHUB_OUTPUT
          else
            echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          fi

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        env:
          GH_TOKEN: ${{ github.token }}
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            You are reviewing PR #${{ steps.pr-info.outputs.pr_number }} in repository ${{ github.repository }}.

            **Your Task:** Perform a comprehensive code review of this pull request.

            **Step-by-step process:**

            1. First, run: `gh pr view ${{ steps.pr-info.outputs.pr_number }} --repo ${{ github.repository }}`
               This will show you the PR title, description, and metadata.

            2. Then run: `gh pr diff ${{ steps.pr-info.outputs.pr_number }} --repo ${{ github.repository }}`
               This will show you all the code changes in the PR.

            3. Use the Read, Grep, and Glob tools to:
               - Read the full content of modified/new files
               - Search for related code patterns
               - Find relevant test files
               - Check for style guide files (CLAUDE.md, CONTRIBUTING.md, etc.)

            4. Analyze the code for:
               - **Code Quality:** Best practices, maintainability, readability
               - **Bugs:** Logic errors, edge cases, potential crashes
               - **Performance:** Inefficiencies, scalability issues
               - **Security:** Vulnerabilities, injection risks, authentication issues
               - **Testing:** Coverage, quality, edge case handling
               - **Architecture:** Consistency with existing patterns
               - **Documentation:** Comments, README updates, API docs

            5. After your thorough review, post a comment using:
               ```bash
               gh pr comment ${{ steps.pr-info.outputs.pr_number }} --repo ${{ github.repository }} --body "YOUR_REVIEW_HERE"
               ```

            **Review Format (use markdown):**
            ```markdown
            ## ðŸ“‹ Summary
            [Brief overview of what this PR does]

            ## ðŸ” What's Changed
            [List the main changes]

            ## âœ… Strengths
            [What's done well]

            ## âš ï¸ Issues Found
            [Any problems discovered - be specific with file:line references]

            ## ðŸ’¡ Suggestions for Improvement
            [Actionable recommendations]

            ## ðŸ”’ Security & Performance Notes
            [Any security or performance concerns]

            ## ðŸ§ª Test Coverage Assessment
            [Analysis of test quality and coverage]

            ## ðŸŽ¯ Overall Recommendation
            [Approve, Request Changes, or Comment with reasoning]
            ```

            **Important:**
            - Be constructive and helpful
            - Cite specific files and line numbers when mentioning issues
            - Prioritize critical issues over style nitpicks
            - Acknowledge good practices when you see them
            - If everything looks good, say so clearly

            Begin your review now!

          # Allow Claude to use necessary tools for code review
          # Using wildcard for Bash to allow all gh commands
          claude_args: >-
            --allowed-tools "Read,Grep,Glob,Bash"


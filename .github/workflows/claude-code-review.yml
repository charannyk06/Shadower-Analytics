name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, ready_for_review]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to review'
        required: true
        type: string

jobs:
  claude-review:
    # Optional: Filter by PR author
    # if: |
    #   github.event.pull_request.user.login == 'external-contributor' ||
    #   github.event.pull_request.user.login == 'new-developer' ||
    #   github.event.pull_request.author_association == 'FIRST_TIME_CONTRIBUTOR'

    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set PR number
        id: pr-info
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "pr_number=${{ github.event.inputs.pr_number }}" >> $GITHUB_OUTPUT
          else
            echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          fi

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ steps.pr-info.outputs.pr_number }}

            Please perform a comprehensive code review of this pull request. Follow these steps:

            1. First, use `gh pr view ${{ steps.pr-info.outputs.pr_number }}` to get PR details (title, description, author)
            2. Use `gh pr diff ${{ steps.pr-info.outputs.pr_number }}` to see all changes
            3. Read the modified and new files to understand the implementation
            4. Review the code for:
               - Code quality and adherence to best practices
               - Potential bugs or logic errors
               - Performance considerations
               - Security vulnerabilities
               - Test coverage and quality
               - Consistency with existing codebase patterns
               - Documentation completeness
            5. Check if there's a CLAUDE.md or CONTRIBUTING.md for style guidelines
            6. Provide constructive, actionable feedback

            After your review, use `gh pr comment ${{ steps.pr-info.outputs.pr_number }} --body "<your review>"` to post your findings.

            Format your review as markdown with clear sections:
            ## Summary
            ## What's Changed
            ## Strengths
            ## Issues Found (if any)
            ## Suggestions for Improvement
            ## Security & Performance Notes
            ## Test Coverage Assessment
            ## Overall Recommendation

            Be thorough but constructive. Focus on helping improve the code.

          # Allow Claude access to necessary tools for comprehensive review
          # Read: access files, Grep: search code, Glob: find files, Bash: run gh commands
          claude_args: '--allowed-tools "Read,Grep,Glob,Bash(gh *)"'


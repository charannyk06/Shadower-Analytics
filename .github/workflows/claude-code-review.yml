name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, ready_for_review]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to review'
        required: true
        type: string

jobs:
  claude-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Fetch full history for proper PR context
          fetch-depth: 0
          # Checkout the PR head ref for pull_request events
          ref: ${{ github.event.pull_request.head.sha || github.sha }}

      - name: Gather PR context
        id: pr-context
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUM="${{ steps.pr-info.outputs.pr_number }}"
          
          # GitHub CLI will automatically use GH_TOKEN from environment
          # No need to authenticate - GITHUB_TOKEN is already set by GitHub Actions
          
          # Get PR details (with error handling)
          if gh pr view $PR_NUM --json title,body,author,files > pr_details.json 2>/dev/null; then
            # Extract information
            echo "title=$(jq -r '.title' pr_details.json)" >> $GITHUB_OUTPUT
            echo "body<<EOF" >> $GITHUB_OUTPUT
            jq -r '.body // "No description provided"' pr_details.json >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "author=$(jq -r '.author.login' pr_details.json)" >> $GITHUB_OUTPUT
            
            # Get changed files list
            jq -r '.files[].path' pr_details.json > changed_files.txt 2>/dev/null || echo "" > changed_files.txt
            echo "files<<EOF" >> $GITHUB_OUTPUT
            cat changed_files.txt >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            
            # Count changes
            echo "files_count=$(wc -l < changed_files.txt | tr -d ' ')" >> $GITHUB_OUTPUT
          else
            # Fallback if gh command fails
            echo "title=PR #$PR_NUM" >> $GITHUB_OUTPUT
            echo "body=No description available" >> $GITHUB_OUTPUT
            echo "author=unknown" >> $GITHUB_OUTPUT
            echo "files=" >> $GITHUB_OUTPUT
            echo "files_count=0" >> $GITHUB_OUTPUT
          fi

      - name: Set PR number
        id: pr-info
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "pr_number=${{ github.event.inputs.pr_number }}" >> $GITHUB_OUTPUT
          else
            echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          fi

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          show_full_output: true
          prompt: |
            You are an expert code reviewer performing a comprehensive security, quality, and correctness analysis of pull request #${{ steps.pr-info.outputs.pr_number }} in the ${{ github.repository }} repository.

            ## Your Task

            Review this pull request systematically and provide actionable, prioritized feedback. Use the GitHub CLI tools available to you to gather all necessary context.

            ## Step 1: Gather PR Information

            First, use these commands to understand the PR:
            - `gh pr view ${{ steps.pr-info.outputs.pr_number }}` - Get PR title, description, and metadata
            - `gh pr diff ${{ steps.pr-info.outputs.pr_number }}` - Get the full diff of all changes
            - `gh pr view ${{ steps.pr-info.outputs.pr_number }} --json files` - Get list of changed files

            ## Step 2: Understand the Codebase Context

            This is a monorepo analytics platform with:
            - **Backend**: Python 3.11 + FastAPI (async), PostgreSQL, Redis, Celery
            - **Frontend**: Next.js 14 (App Router), TypeScript, React, TanStack Query, Tailwind CSS
            - **Architecture**: Microservice with JWT auth, RBAC, multi-tenant workspaces
            - **Key Patterns**: Async/await, dependency injection, service layer pattern, materialized views

            For each changed file, examine:
            - Related files (imports, dependencies, tests)
            - How it fits into the overall architecture
            - Database schema implications (if applicable)
            - API contract changes (if applicable)

            ## Step 3: Review Methodology

            Follow this systematic approach:

            ### 3.1 Security Analysis
            - SQL injection vulnerabilities (parameterized queries?)
            - XSS vulnerabilities (input sanitization?)
            - Authentication/authorization bypasses
            - Exposed secrets or sensitive data
            - Insecure dependencies or outdated packages
            - CORS misconfigurations
            - Rate limiting gaps
            - JWT token handling issues

            ### 3.2 Correctness & Logic
            - Logic errors or edge cases not handled
            - Race conditions or concurrency issues
            - Null/undefined handling (especially in TypeScript)
            - Type safety violations
            - Data validation gaps
            - Error handling completeness
            - Database transaction boundaries
            - Async/await error propagation

            ### 3.3 Performance
            - N+1 query problems
            - Missing database indexes
            - Inefficient algorithms
            - Memory leaks or resource leaks
            - Missing caching opportunities
            - Large bundle sizes (frontend)
            - Unnecessary re-renders (React)
            - Missing pagination

            ### 3.4 Code Quality
            - DRY violations (code duplication)
            - Unclear naming or poor abstractions
            - Missing or inadequate comments
            - Code that doesn't follow project conventions
            - Dead code or commented-out code
            - Inconsistent error handling patterns

            ### 3.5 Testing
            - Missing test coverage for new code
            - Tests that don't actually test functionality
            - Missing edge case tests
            - Integration test gaps
            - Test quality and maintainability

            ### 3.6 Architecture & Design
            - SOLID principle violations
            - Tight coupling or poor separation of concerns
            - API design consistency
            - Breaking changes to public APIs
            - Database migration safety
            - Backward compatibility

            ## Step 4: Severity Classification

            Classify each issue with clear reasoning:

            **ðŸ”´ BLOCKING** - Must fix before merge:
            - Security vulnerabilities
            - Bugs that break functionality
            - Data loss/corruption risks
            - Crashes or unhandled exceptions in critical paths
            - Breaking changes to public APIs without migration

            **ðŸŸ¡ IMPORTANT** - Should address (may merge with plan):
            - Performance problems affecting users
            - Missing error handling in important flows
            - Hard-to-maintain code causing future problems
            - Inadequate test coverage for risky changes
            - Minor security concerns

            **ðŸ”µ SUGGESTION** - Nice to have:
            - Code style improvements
            - Minor optimizations
            - Better naming/structure
            - Additional documentation
            - Refactoring opportunities

            ## Step 5: Output Format

            Write your review to `review_comment.md` file using this structure:

            ```markdown
            ## ðŸ¤– Claude Code Review

            ### ðŸ“Š Summary
            [2-3 sentence overview of the PR and your overall assessment]

            **Recommendation**: APPROVE | REQUEST_CHANGES | COMMENT

            ---

            ### âœ… Strengths
            - [Positive aspect 1]
            - [Positive aspect 2]
            - [What was done well]

            ---

            ### ðŸ”´ Blocking Issues (Must Fix)

            #### [File Path]:[Line Number] - [Issue Title]
            **Problem**: [What's wrong and why it matters]
            
            **Impact**: [What could go wrong in production]
            
            **Fix**: 
            ```[language]
            [Specific code example showing the fix]
            ```

            ---

            ### ðŸŸ¡ Important Issues (Should Fix)

            #### [File Path]:[Line Number] - [Issue Title]
            **Problem**: [Description]
            
            **Recommendation**: [Specific suggestion]

            ---

            ### ðŸ”µ Suggestions (Nice to Have)

            #### [File Path]:[Line Number] - [Suggestion Title]
            [Brief explanation and optional code example]

            ---

            ### ðŸ§ª Testing Recommendations
            - [Specific test scenario 1]
            - [Specific test scenario 2]
            - [Edge cases to test]

            ---

            ### ðŸ“š Documentation Needs
            - [Documentation that should be updated]
            - [API docs that need changes]

            ---

            ### ðŸ“ Detailed Line-by-Line Notes

            #### `filename.ext`
            - **Line X-Y**: [Observation or minor note]
            - **Line Z**: [Another observation]

            ---

            **Review completed at**: [timestamp]
            ```

            ## Step 6: Post Review - CRITICAL STEP

            **YOU MUST WRITE YOUR REVIEW TO A FILE.**

            After completing your analysis, write your complete review to `review_comment.md`:

            ```bash
            cat > review_comment.md << 'EOF'
            ## ðŸ¤– Claude Code Review

            ### ðŸ“Š Summary
            [Your summary here]

            [Rest of your review...]
            EOF
            ```

            **IMPORTANT**: 
            - Write the complete review to `review_comment.md` in the repository root
            - The workflow will automatically post it as a PR comment
            - If the review is very large (>4000 characters), you can split it into multiple files:
              - `review_comment_part1.md` (Critical blocking issues)
              - `review_comment_part2.md` (Important issues)
              - `review_comment_part3.md` (Suggestions and detailed notes)

            ## Important Guidelines

            1. **Be Specific**: Reference exact file paths and line numbers
            2. **Be Actionable**: Every issue should have a clear recommendation
            3. **Be Constructive**: Explain the "why" behind your feedback
            4. **Prioritize**: Focus on blocking issues first
            5. **Consider Context**: Understand the codebase patterns before suggesting changes
            6. **Think Production**: Consider what could go wrong in production
            7. **Be Concise**: Don't overwhelm with minor style issues unless they're patterns

            ## Edge Cases

            - **Large PR (>20 files)**: Focus on critical files (auth, data access, API endpoints) first. Note if full review was limited.
            - **No issues found**: Explicitly state "No significant issues found" and highlight what was reviewed.
            - **Uncertainty**: State confidence level: "I'm uncertain if X because Y. Recommend testing Z."
            - **Missing context**: Explicitly ask for needed information.

            ---

            **PR Number**: ${{ steps.pr-info.outputs.pr_number }}
            **Repository**: ${{ github.repository }}
            **PR Title**: ${{ steps.pr-context.outputs.title }}
            **Author**: ${{ steps.pr-context.outputs.author }}
            **Changed Files**: ${{ steps.pr-context.outputs.files_count }} files

            Begin your review now. Use the GitHub CLI tools (`gh pr view`, `gh pr diff`) to gather all context, then provide your comprehensive analysis.

            **CRITICAL**: Write your complete review to a file named `review_comment.md` in the repository root. The workflow will automatically post it as a PR comment. Use this format:

            ```bash
            cat > review_comment.md << 'EOF'
            [Your complete review in markdown format]
            EOF
            ```

            **DO NOT** try to use `gh pr comment` directly - write to `review_comment.md` instead.

      - name: Post Review Comment
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUM="${{ steps.pr-info.outputs.pr_number }}"
          
          # Check if review file exists
          if [ -f "review_comment.md" ]; then
            echo "Found review_comment.md, posting to PR..."
            gh pr comment $PR_NUM --body-file review_comment.md
          elif [ -f "review_comment_part1.md" ]; then
            echo "Found split review files, posting parts..."
            # Post parts in order
            for part in review_comment_part1.md review_comment_part2.md review_comment_part3.md; do
              if [ -f "$part" ]; then
                echo "Posting $part..."
                gh pr comment $PR_NUM --body-file "$part"
              fi
            done
          else
            echo "No review file found. Claude may not have completed the review."
            echo "Check the workflow logs for Claude's output."
          fi
